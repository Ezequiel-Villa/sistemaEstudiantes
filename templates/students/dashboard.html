{% extends 'base.html' %}
{% block title %}Dashboard · Sistema de Estudiantes{% endblock %}
{% block content %}
<section class="page-hero">
    <div>
        <p class="muted">Resumen general</p>
        <h1>Dashboard Principal</h1>
        <p>Visión global del sistema de registro de estudiantes.</p>
    </div>
    <div class="actions-inline">
        <a class="btn btn-ghost" href="{% url 'students:student_list' %}"><svg class="icon" aria-hidden="true"><use href="#icon-table"></use></svg> Ver estudiantes</a>
        <a class="btn btn-primary" href="{% url 'students:student_create' %}"><svg class="icon" aria-hidden="true"><use href="#icon-user-plus"></use></svg> Nuevo estudiante</a>
    </div>
</section>

<div class="stat-grid">
    <article class="stat-card">
        <span class="stat-icon" style="background: var(--accent-soft); color: var(--accent);"><svg class="icon" aria-hidden="true"><use href="#icon-users"></use></svg></span>
        <div>
            <p class="stat-title">Total de estudiantes</p>
            <p class="stat-value">{{ students_total }}</p>
        </div>
    </article>
    <article class="stat-card">
        <span class="stat-icon" style="background: #e8f6ed; color: var(--success);"><svg class="icon" aria-hidden="true"><use href="#icon-check-circle"></use></svg></span>
        <div>
            <p class="stat-title">Inscritos</p>
            <p class="stat-value">{{ status_counts.inscrito }}</p>
        </div>
    </article>
    <article class="stat-card">
        <span class="stat-icon" style="background: #fff4e5; color: var(--warning);"><svg class="icon" aria-hidden="true"><use href="#icon-alert-circle"></use></svg></span>
        <div>
            <p class="stat-title">Baja temporal</p>
            <p class="stat-value">{{ status_counts.baja_temporal }}</p>
        </div>
    </article>
    <article class="stat-card">
        <span class="stat-icon" style="background: #ffe5e7; color: var(--danger);"><svg class="icon" aria-hidden="true"><use href="#icon-minus-circle"></use></svg></span>
        <div>
            <p class="stat-title">Baja definitiva</p>
            <p class="stat-value">{{ status_counts.baja_definitiva }}</p>
        </div>
    </article>
    <article class="stat-card">
        <span class="stat-icon" style="background: #e0f2fe; color: var(--info);"><svg class="icon" aria-hidden="true"><use href="#icon-graduation"></use></svg></span>
        <div>
            <p class="stat-title">Egresados</p>
            <p class="stat-value">{{ status_counts.egresado }}</p>
        </div>
    </article>
</div>

<div class="section-grid" style="margin-top:18px;">
    <div class="surface">
        <div class="panel-heading">
            <div>
                <p class="muted" style="margin:0;">Tablas dinámicas</p>
                <h3 class="heading-title">Estadísticas por grupo y carrera</h3>
                <p class="heading-sub">Generadas con pandas</p>
            </div>
            <a class="btn btn-ghost" href="{% url 'students:student_list' %}"><svg class="icon" aria-hidden="true"><use href="#icon-table"></use></svg> Tabla completa</a>
        </div>
        {% if stats_by_group %}
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Grupo</th>
                        <th>Carrera</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in stats_by_group %}
                    <tr>
                        <td><strong>{{ row.grupo }}</strong></td>
                        <td>{{ row.carrera }}</td>
                        <td>{{ row.total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if career_stats %}
        <div class="surface" style="margin-top:12px; box-shadow:none; border:1px dashed var(--border);">
            <p class="muted" style="margin:0 0 6px;">Resumen por carrera</p>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Carrera</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in career_stats %}
                        <tr>
                            <td>{{ row.carrera }}</td>
                            <td style="text-align:right;">{{ row.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        {% else %}
            <p class="muted">Aún no hay estudiantes registrados.</p>
        {% endif %}
    </div>
    <div class="surface">
        <div class="panel-heading">
            <div>
                <p class="muted" style="margin:0;">Recursos externos</p>
                <h3 class="heading-title">Universidades en el mundo</h3>
                <p class="heading-sub">Consulta universidades por país usando la API de Hipolabs.</p>
            </div>
        </div>
        <div class="page-section">
            <a class="btn btn-primary" href="{% url 'students:universities' %}"><svg class="icon" aria-hidden="true"><use href="#icon-building"></use></svg> Ver universidades</a>
            <div class="actions-inline">
                <a class="btn btn-ghost" href="{% url 'students:student_create' %}"><svg class="icon" aria-hidden="true"><use href="#icon-user-plus"></use></svg> Nuevo estudiante</a>
                <a class="btn btn-ghost" href="{% url 'students:student_list' %}"><svg class="icon" aria-hidden="true"><use href="#icon-search"></use></svg> Buscar estudiantes</a>
            </div>
        </div>
    </div>
</div>

<div class="section-grid" style="margin-top:18px;">
    <div class="surface">
        <div class="panel-heading">
            <div>
                <h4 class="heading-title">Distribución por grupo</h4>
                <p class="heading-sub">Visualización con Chart.js</p>
            </div>
        </div>
        <div class="chart-box"><canvas id="groupChart"></canvas></div>
    </div>
    <div class="surface">
        <div class="panel-heading">
            <div>
                <h4 class="heading-title">Estados académicos</h4>
                <p class="heading-sub">Distribución por situación actual</p>
            </div>
        </div>
        <div class="chart-box"><canvas id="statusChart"></canvas></div>
    </div>
    <div class="surface">
        <div class="panel-heading">
            <div>
                <h4 class="heading-title">Carreras con más estudiantes</h4>
                <p class="heading-sub">Conteo por especialidad</p>
            </div>
        </div>
        <div class="chart-box"><canvas id="careerChart"></canvas></div>
    </div>
</div>
{{ charts|json_script:"charts-data" }}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
    (() => {
        const charts = JSON.parse(document.getElementById('charts-data').textContent);
        const palette = ['#2563eb', '#20c997', '#f59e0b', '#a855f7', '#0ea5e9', '#ef4444'];

        const groupCtx = document.getElementById('groupChart');
        if (groupCtx) {
            new Chart(groupCtx, {
                type: 'bar',
                data: {
                    labels: charts.group.labels,
                    datasets: [{
                        label: 'Estudiantes',
                        data: charts.group.values,
                        backgroundColor: palette.slice(0, charts.group.labels.length),
                    }],
                },
                options: {
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                },
            });
        }

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: charts.status.labels,
                    datasets: [{
                        data: charts.status.values,
                        backgroundColor: ['#16a34a', '#f59e0b', '#ef4444', '#0ea5e9'],
                        borderWidth: 1,
                    }],
                },
                options: {
                    plugins: { legend: { position: 'bottom' } },
                    maintainAspectRatio: false,
                },
            });
        }

        const careerCtx = document.getElementById('careerChart');
        if (careerCtx) {
            new Chart(careerCtx, {
                type: 'bar',
                data: {
                    labels: charts.career.labels,
                    datasets: [{
                        label: 'Estudiantes',
                        data: charts.career.values,
                        backgroundColor: palette.slice(0, charts.career.labels.length),
                    }],
                },
                options: {
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                },
            });
        }
    })();
</script>
{% endblock %}
