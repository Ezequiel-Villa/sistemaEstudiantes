{% extends 'base.html' %}
{% block title %}Dashboard · Sistema de Estudiantes{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Dashboard Principal</h1>
        <p class="page-subtitle">Resumen general del sistema de registro de estudiantes.</p>
    </div>
    <div class="actions-row">
        <a class="button button-secondary" href="{% url 'students:student_list' %}"><i class="bi bi-table"></i> Ver estudiantes</a>
        <a class="button button-primary" href="{% url 'students:student_create' %}"><i class="bi bi-person-plus"></i> Nuevo estudiante</a>
    </div>
</div>

<div class="metrics-grid">
    <div class="metric-tile">
        <div class="icon-circle icon-primary"><i class="bi bi-people"></i></div>
        <div>
            <p class="text-muted">Total de estudiantes</p>
            <h3>{{ students_total }}</h3>
        </div>
    </div>
    <div class="metric-tile">
        <div class="icon-circle icon-success"><i class="bi bi-check-circle"></i></div>
        <div>
            <p class="text-muted">Inscritos</p>
            <h3>{{ status_counts.inscrito }}</h3>
        </div>
    </div>
    <div class="metric-tile">
        <div class="icon-circle icon-warning"><i class="bi bi-exclamation-circle"></i></div>
        <div>
            <p class="text-muted">Baja temporal</p>
            <h3>{{ status_counts.baja_temporal }}</h3>
        </div>
    </div>
    <div class="metric-tile">
        <div class="icon-circle icon-danger"><i class="bi bi-dash-circle"></i></div>
        <div>
            <p class="text-muted">Baja definitiva</p>
            <h3>{{ status_counts.baja_definitiva }}</h3>
        </div>
    </div>
    <div class="metric-tile">
        <div class="icon-circle icon-info"><i class="bi bi-mortarboard"></i></div>
        <div>
            <p class="text-muted">Egresados</p>
            <h3>{{ status_counts.egresado }}</h3>
        </div>
    </div>
    <div class="metric-tile">
        <div class="icon-circle icon-primary"><i class="bi bi-diagram-3"></i></div>
        <div>
            <p class="text-muted">Grupos distintos</p>
            <h3>{{ groups_count }}</h3>
        </div>
    </div>
</div>

<div class="grid-layout" style="margin-top: 16px;">
    <div class="app-card section-grid">
        <div class="card-header-row">
            <div>
                <h4>Estadísticas por grupo y carrera</h4>
                <p class="page-subtitle">Generadas con pandas</p>
            </div>
            <a class="button button-ghost" href="{% url 'students:student_list' %}"><i class="bi bi-table"></i> Ver tabla completa</a>
        </div>
        {% if stats_by_group %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Grupo</th>
                            <th>Carrera</th>
                            <th>Total de estudiantes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in stats_by_group %}
                        <tr>
                            <td><strong>{{ row.grupo }}</strong></td>
                            <td>{{ row.carrera }}</td>
                            <td>{{ row.total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if career_stats %}
            <div class="section-grid">
                <h6 class="text-muted">Resumen por carrera</h6>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Carrera</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in career_stats %}
                            <tr>
                                <td>{{ row.carrera }}</td>
                                <td style="text-align: right;">{{ row.total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        {% else %}
            <p class="text-muted">Aún no hay estudiantes registrados.</p>
        {% endif %}
    </div>
    <div class="app-card section-grid">
        <div class="card-header-row">
            <div>
                <h4>Universidades en el mundo</h4>
                <p class="page-subtitle">Consulta universidades por país usando la API de Hipolabs.</p>
            </div>
        </div>
        <a class="button button-primary" href="{% url 'students:universities' %}"><i class="bi bi-building"></i> Ver universidades</a>
        <div class="section-grid">
            <h6 class="text-muted">Acciones rápidas</h6>
            <div class="actions-row">
                <a class="button button-secondary" href="{% url 'students:student_create' %}"><i class="bi bi-person-plus"></i> Nuevo estudiante</a>
                <a class="button button-secondary" href="{% url 'students:student_list' %}"><i class="bi bi-search"></i> Buscar estudiantes</a>
            </div>
        </div>
    </div>
</div>

<div class="grid-layout" style="margin-top: 18px;">
    <div class="app-card">
        <div class="card-header-row">
            <div>
                <h6 style="margin:0;">Distribución por grupo</h6>
                <small class="text-muted">Visualización con Chart.js</small>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="groupChart"></canvas>
        </div>
    </div>
    <div class="app-card">
        <div class="card-header-row">
            <div>
                <h6 style="margin:0;">Estados académicos</h6>
                <small class="text-muted">Distribución por situación actual</small>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
    <div class="app-card">
        <div class="card-header-row">
            <div>
                <h6 style="margin:0;">Carreras con más estudiantes</h6>
                <small class="text-muted">Conteo por especialidad</small>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="careerChart"></canvas>
        </div>
    </div>
</div>
{{ charts|json_script:"charts-data" }}
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
    (() => {
        const charts = JSON.parse(document.getElementById('charts-data').textContent);
        const palette = ['#2563eb', '#20c997', '#f59e0b', '#a855f7', '#0ea5e9', '#ef4444'];

        const groupCtx = document.getElementById('groupChart');
        if (groupCtx) {
            new Chart(groupCtx, {
                type: 'bar',
                data: {
                    labels: charts.group.labels,
                    datasets: [{
                        label: 'Estudiantes',
                        data: charts.group.values,
                        backgroundColor: palette.slice(0, charts.group.labels.length),
                    }],
                },
                options: {
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                },
            });
        }

        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: charts.status.labels,
                    datasets: [{
                        data: charts.status.values,
                        backgroundColor: ['#16a34a', '#f59e0b', '#ef4444', '#0ea5e9'],
                        borderWidth: 1,
                    }],
                },
                options: {
                    plugins: { legend: { position: 'bottom' } },
                    maintainAspectRatio: false,
                },
            });
        }

        const careerCtx = document.getElementById('careerChart');
        if (careerCtx) {
            new Chart(careerCtx, {
                type: 'bar',
                data: {
                    labels: charts.career.labels,
                    datasets: [{
                        label: 'Estudiantes',
                        data: charts.career.values,
                        backgroundColor: palette.slice(0, charts.career.labels.length),
                    }],
                },
                options: {
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                },
            });
        }
    })();
</script>
{% endblock %}
